function init(t){function e(t,e){var o=b("<"+t+"></"+t+">");return e&&o.html(e),o}function o(t){return function(o,a){var n=e(t,o);return a&&n.addClass(a),n}}var a=o("p"),n=o("div"),r=o("section"),s=o("h2");function l(t,e){return n(e,t)}function i(t,e){return n(e).attr("id",t)}var p="90% 2011 LHA Rate",c="2020 LHA Rate",u=Chart.defaults.global;u.defaultFontFamily="Roboto",u.legend.position="right",u.maintainAspectRatio=!1,u.tooltips.callbacks.label=function(t,e){var o=e.datasets[t.datasetIndex];return o.label+": "+k(o.data[t.index])};var f='<button type="button" class="f-b button-light w-button"></button>',d=t.sections,h=t.errorMessages,m=t.buttons,b=jQuery,v=b("#tool"),g=l("f-prog",'<div class="cnctr"><div class="cnctr-prog"></div></div>').appendTo(v),_=l("loading","Loading...").appendTo(v),w=b('<form action=""></form>').appendTo(v);w.on("submit",function(o){if(o.preventDefault(),T()){w.find("input, select").removeAttr("disabled");var n={};w.serializeArray().forEach(function(t){var e=t.value.trim(),o=+e;n[t.name]=isNaN(o)?e:o}),function(o){if(!t.submitted&&t.form.id){var n=t.form,u={};Object.keys(n.fields).forEach(function(t){t in o&&(u[n.fields[t]]=o[t])}),b.ajax({url:"https://docs.google.com/forms/d/"+n.id+"/formResponse?ifq",data:u,type:"POST",dataType:"xml"}),t.submitted=!0}var h=t.report,_=h.sections,T=t.report.charts,S=[{key:"low",label:"Low support needs"},{key:"med",label:"Medium support needs"},{key:"high",label:"High support needs"}],C=0,M=0;["hotels","bnb","hostels"].forEach(function(t){C+=o["ta_new_"+t],M+=o["ta_new_"+t]*o["cost_"+t]});var L=C+o.ta_new_others,P=["bnb","hostels","nightly_paid_shared","prs_shared"].reduce(function(t,e){return t+o["ta_old_"+e]},0),N=o.ta_new_nprf/100,B=[{rows:[[o.la],[o.la2],[o.brma],[o.brma2]]},{wideLabels:!0,rows:[[],[],[]]},{wideLabels:!0,rows:[[k(o.asm_prs_mgmt),k(o.asm_srs_mgmt)],[k(o.asm_prs_move_in_supp),k(o.asm_srs_move_in_supp)],[k(o.asm_prs_med_supp),k(o.asm_srs_med_supp)],[k(o.asm_prs_high_supp),k(o.asm_srs_high_supp)],[x(o.asm_out_of_borough_prs)+" (of PRS only)",x(o.asm_out_of_borough_total)+" (of total)"]]},{rows:[],hasTotal:!0},{rows:[],hasTotal:!0}];B.forEach(function(t,e){t.title=_[0].tables[e],t.cols=_[0].headers[e];var o=_[0].rowLabels[e];o&&t.rows.forEach(function(t,e){t.unshift(o[e])})});var I={label:"Total",number:0,cost:0};S.forEach(function(t){var e=L*o["ta_new_"+t.key]/100*(1-N);B[3].rows.push({label:t.label,number:e}),B[4].rows.push([t.label,o["ta_old_"+t.key]/100*P])}),B[3].rows.push({label:"NRPF",number:L*N}),B[3].rows.forEach(function(t){t.cost=M/C*t.number*4,I.number+=t.number,I.cost+=t.cost}),B[4].rows.push(["Total",P]);var O={la:o.la,brma:o.brma},H={la:o.la2,brma:o.brma2};E.forEach(function(t){t.lookup&&t.data.forEach(function(e){[O,H].forEach(function(o){-1!==[o.la,o.brma].indexOf(e[t.lookup])&&(o[t.tab]=e)})})}),B[1].cols[0].forEach(function(t,e){if(e>0){var o=parseInt(O["PRS"===t?"PRS":"SRS"].Stock),a=I.number/o;B[1].rows[0].push(o),B[1].rows[1].push(x(100*a)),B[1].rows[2].push(a<.33?"Low":a>1?"Very High":a>.66?"High":"Moderate")}});for(var $=[],j=1;j<_.length;j++){for(var D=_[j],F={title:D.title,tables:[]},q=0;q<2;q++){var U=D.firstHeaders,V={title:D.tables[q],cols:[[""],[""]],rows:[new Array(2*D.otherHeaders.length+(U?U.length-1:0)).fill(0)]};U&&V.cols.forEach(function(t,e){t.push(U[e])});var z="Move to PRS ";j%2==0&&(z+="and SRS "),D.otherHeaders.forEach(function(t){V.cols[0].push({cols:2,label:t}),V.cols[1].push(z+"as TA"),V.cols[1].push(z+"as Permanent Accommodation")}),F.tables.push(V)}$.push(F)}function J(t,e){var a=e?"asm_srs_":"asm_prs_",n=o[a+"mgmt"]+o[a+"move_in_supp"],r=S[t].key;return"med"===r?n+=o[a+"med_supp"]:"high"===r&&(n+=o[a+"high_supp"]),n}function Z(t,e,o,a,n){o=o.map(function(t,e){return{label:a.labels[e],backgroundColor:a.colours[e],data:t}}),n.plugins={datalabels:{color:"white",display:!0,align:"center",anchor:"center",font:{weight:"bold",size:12},formatter:k}};var r=document.getElementById(t).getContext("2d");new Chart(r,{type:"bar",data:{labels:e,datasets:o},options:n})}S.forEach(function(t,e){$.forEach(function(a,n){a.tables.forEach(function(a,r){var s=function(t,e,a,n){var r=e?o.asm_out_of_borough_prs:0,s=R(O.PRS.Rent,H.PRS.Rent,r)+J(t,!1),l=s-R(O.BRMAs[p],H.BRMAs[p],r),i=s-R(O.BRMAs[c],H.BRMAs[c],r);if(a){var u=J(t,!0),f=o.asm_out_of_borough_total;l=R(u,l,f),i=R(u,i,f)}if(n){var d=B[3].rows[t],h=d.number*l*4,m=d.number*i*4;return[d.cost,h,m,d.cost-h,d.cost-m,12*(d.cost-h),12*(d.cost-m)]}var b=B[4].rows[t];return[b[1]*l*4,b[1]*i*4,b[1]*l*4*12,b[1]*i*4*12]}(e,r>0,n%2==1,n<=1);s.forEach(function(t,e){a.rows[a.rows.length-1][e]+=t}),a.rows.splice(-1,0,[t.label].concat(s.map(k)))})})}),B[3].rows.push(I),B[3].rows=B[3].rows.map(function(t){return[t.label,A(t.number),k(t.cost)]}),B[4].rows.forEach(function(t){t[1]=A(t[1])}),$.forEach(function(t){t.full=!0,t.tables.forEach(function(t){t.hasTotal=!0,t.rows[t.rows.length-1]=t.rows[t.rows.length-1].map(k),t.rows[t.rows.length-1].unshift("Total")})}),$.unshift({tables:B,full:!1}),w.hide(),g.hide();var K=i("report").append(e("img").attr("src",h.image)).append(s(h.title)).append(s(h.subtitle,"subtitle")).appendTo(v);h.intro.forEach(function(t){a(t,"intro").appendTo(K)}),$.forEach(function(t,a){var n=r("","r-s");t.title&&(n.addClass("ol"),n.append(e("h4",t.title).addClass("s-t")));var s,i,u,f=null;if(t.tables.forEach(function(o,a){a%(t.full?1:3)==0&&(f=l("ts").toggleClass("full",t.full).appendTo(n)),f.append(function(t,o){var a=e("table");t.wideLabels&&a.addClass("wl");var n=[],r=!1;if((t.cols?t.cols[0]:t.rows[0]).forEach(function(t){for(var e=t.cols||1,o=0;o<e;o++)n.push(r?"even":"odd");r=!r}),t.cols){var s=e("thead").appendTo(a);t.cols.length>1&&s.addClass("multirow"),t.cols.forEach(function(t){var o=e("tr").appendTo(s),a=0;t.forEach(function(t){var r=e("th").addClass(n[a]).appendTo(o);"object"==typeof t?(r.attr("colspan",t.cols).html(t.label),a+=t.cols):(r.html(t),a++)})})}var i=e("tbody").appendTo(a);t.rows.forEach(function(o,a){var r=e("tr").appendTo(i),s=0;o.forEach(function(t){var o=e("td").append(t).appendTo(r);n&&o.addClass(n[s++])}),t.hasTotal&&a===t.rows.length-1&&r.addClass("totals")});var p=l("t-title","<h4>"+t.title+"</h4>");if(o){var c=t.rows[t.rows.length-1];b('<h4 class="t-total"></h4>').html(c[c.length-1]).appendTo(p)}return l("t").append(p).append(a)}(o,t.full))}),K.append(n),0===a){var d=r("","charts ol").appendTo(K);[1,2].forEach(function(t){l("chart").append(e("h4",T[t-1].title).addClass("s-t")).append(e("canvas").attr("id","chart"+t)).appendTo(d)}),s="chart1",i=[],u=[[],[],[],[],[]],["prs","srs"].forEach(function(t){S.forEach(function(e){var a=e.label.split(" ");i.push(["Cost "+t.toLocaleUpperCase()+",",a[0],a.slice(1).join(" ")]),u[0].push(O["prs"===t?"PRS":"SRS"].Rent),u[1].push(o["asm_"+t+"_mgmt"]),u[2].push(o["asm_"+t+"_move_in_supp"]),u[3].push("low"===e.key?null:o["asm_"+t+"_med_supp"]),u[4].push("high"!==e.key?null:o["asm_"+t+"_high_supp"])})}),Z(s,i,u,T[0],{tooltips:{mode:"index",filter:function(t,e){var o=e.datasets[t.datasetIndex].data[t.index];return!isNaN(o)&&null!==o},callbacks:{title:function(t){return t[0].label.replace(",,","\n").replace(","," ")}}},legend:{reverse:!0},scales:{xAxes:[{stacked:!0}],yAxes:[{stacked:!0,ticks:{beginAtZero:!0,callback:k}}]}}),function(t){var e=[],o=[[],[],[]];S.forEach(function(t,a){e.push(t.label);var n=O.PRS.Rent+J(a,!1);o[0].push(n-O.BRMAs[p]),o[1].push(n-O.BRMAs[c]),o[2].push(J(a,!0))}),Z(t,e,o,T[1],{scales:{xAxes:[{}],yAxes:[{ticks:{beginAtZero:!0,callback:k}}]}})}("chart2")}});var Q=l("f-bs").appendTo(K);b(f).text(m.change).on("click",function(){w.show(),g.show(),K.remove(),y(d.length-1)}).appendTo(Q),b(f).html(m.download).on("click",function(){K.addClass("topdf");var t=i("cloth","Converting to pdf...").appendTo(b("body"));function e(){for(var t in Chart.instances)Chart.instances[t].resize()}e(),setTimeout(function(){html2pdf().from(K[0]).set({margin:.2,filename:"report-"+(new Date).toISOString().substr(0,16).replace(/[^0-9]/g,"")+".pdf",html2canvas:{scale:2,ignoreElements:function(t){return b(t).hasClass("f-bs")}},jsPDF:{unit:"in",format:"a4",orientation:"landscape"}}).save().finally(function(){K.removeClass("topdf"),t.remove(),e()})},100)}).appendTo(Q)}(n)}});var E={};function y(e){t.pageIndex=e;var o=d[e],a=w.find(".f-p").hide();a.find("input, select").attr("disabled","disabled"),a.filter("#"+o.id).show().find("input, select").removeAttr("disabled"),g.find(".cnctr-prog").css({width:100*e/(d.length-1)+"%"}),g.find(".p-n").each(function(t){b(this).toggleClass("active",t<=e)}),g.offset().top<b(window).scrollTop()&&g.get(0).scrollIntoView({behavior:"smooth"})}function T(){var e=w.get(0),o="reportValidity",a=!e[o]||e[o]();return d[t.pageIndex].groups.forEach(function(t){t.inputs.forEach(function(t){M(t),a&=!t.error});var e=L(t);a&=!e,t.inputs.forEach(function(t){S(t,t.error||e)})}),a}function R(t,e,o){return(1-(o/=100))*t+o*e}function k(t){return"Â£"+Math.round(t).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function x(t){return Math.round(100*t)/100+"%"}function A(t){return Math.round(10*t)/10}function S(t,e){var o=e?"slideDown":"slideUp";t.$dom.closest(".f-g").toggleClass("invalid",!!e).find(".err-msg")[o]().text(e)}function C(t,e){if(M(t),e.validation){var o=L(e);e.inputs.forEach(function(t){S(t,t.error||o)})}else S(t,t.error)}function M(t){var e=(t.$dom.val()||"").trim(),o=null;if(e||(o="req",t.$dom.attr("inputmode")&&(o+="Num")),!o)if("email"===t.type)/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,})+$/.test(e)||(o="email");else if("text"===t.type);else if("checkbox"===t.type);else if("select"!==t.type){isNaN(+e)||e<0?o="posNum":"percent"===t.type&&e>100&&(o="percent")}t.error=o?h[o]:null}function L(t){var e=null;if("percent"===t.validation){var o=0,a=0;t.inputs.forEach(function(t){t.error||(o+=parseInt(t.$dom.val().trim()),a++)}),a===t.inputs.length&&100!==o&&(e=h.percentTotal)}return e}["LAs","BRMAs","PRS","SRS"].forEach(function(t){E[t]={tab:t,complete:!1,inputs:[]}}),E.BRMAs.lookup="BRMA",E.PRS.lookup="LA",E.SRS.lookup="LA",d.forEach(function(t,o){l("p-n",o+1).appendTo(g),t.id="section-"+(o+1);var n=r("","f-p").attr("id",t.id).append(s("Section "+(o+1),"s-n")).append(s(t.title,"s-t"));t.desc.forEach(function(t){n.append(a(t))}),t.groups.forEach(function(t,r){var s=e("fieldset");if(t.label&&s.append(e("legend",t.label)),t.desc){var i=l("f-d").appendTo(s);t.desc.forEach(function(t){i.append(a(t))})}t.inputs.forEach(function(a,n){var i="input_"+o+"-"+r+"-"+n;"select"===a.type&&E[a.source[0]].inputs.push(a);var p=function(t){switch(t.type){case"checkbox":return e("input").attr("type","checkbox").attr("value",t.value);case"select":return e("select",'<option selected disabled value="">'+t.placeholder+"</option>");case"text":case"email":return e("input").attr("type",t.type);default:var o=b('<input type="text" inputmode="numeric" pattern="[0-9]+"/>');return t.default&&o.attr("value",t.default),o}}(a),c=l("w-input"+(a.type?" type-"+a.type:""),"pounds"===a.type?l("i-pre","&pound;"):null);a.optional||p.attr("required","required"),p.attr("id",i).attr("name",a.name).on("change",function(){C(a,t)}).on("blur",function(){C(a,t)}).appendTo(c),a.$dom=p,"percent"===a.type&&c.append(l("i-suf","%")),l("f-g").append(e("label",a.label).attr("for",i)).append(c).append(l("err-msg")).appendTo(s)}),s.appendTo(n)});var i=l("f-bs").appendTo(n);o>0?b(f).text(m.prev).on("click",function(){y(o-1)}).appendTo(i):l(null,"&nbsp;").appendTo(i),o===d.length-1?b(f).text(m.submit).attr("type","submit").on("click",function(){T()}).appendTo(i):o<d.length-1&&b(f).text(m.next).on("click",function(){T()&&y(o+1)}).appendTo(i),n.appendTo(w)}),(E=Object.values(E)).forEach(function(o){b.get("https://sheets.googleapis.com/v4/spreadsheets/"+t.sheetId+"/values/"+o.tab+"?valueRenderOption=UNFORMATTED_VALUE&key="+t.apiKey).then(function(t){var a=t.values.shift().map(function(t){return(""+t).trim()});o.data=t.values.map(function(t){var e={};return a.forEach(function(o,a){e[o]=t[a]}),e}),o.complete=!0,E.map(function(t){return t.complete}).filter(Boolean).length===E.length&&(E.forEach(function(t){t.inputs.forEach(function(o){t.data.forEach(function(t){var a=t[o.source[1]],n=o.$dom;if(o.source.length>2){var r=t[o.source[2]],s=o.$dom.find('optgroup[label="'+r+'"]');s.length||(s=e("optgroup").attr("label",r).appendTo(n)),n=s}n.append(e("option",a).attr("value",a))})})}),_.remove(),y(0))}).catch(function(t){t&&t.responseJSON&&(t=t.responseJSON.error||t.responseJSON),_.text(t.message||t),console.error(t)})})}try{init(costingTool)}catch(t){console.error(t)}
