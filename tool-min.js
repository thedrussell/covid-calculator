function init(t){function e(t,e){var o=i("<"+t+"></"+t+">");return e&&o.html(e),o}function o(t,o){var n=e("div",o);return t&&n.addClass(t),n}function n(t,o){return e("div",o).attr("id",t)}var a='<button type="button" class="f-b button-light w-button"></button>',r=t.sections,s=t.errorMessages,l=t.buttons,i=jQuery,c=i("#tool"),p=o("f-prog",'<div class="cnctr"><div class="cnctr-prog"></div></div>').appendTo(c),u=o("loading","Loading...").appendTo(c),f=i('<form action=""></form>').appendTo(c);f.on("submit",function(s){if(s.preventDefault(),m()){f.find("input, select").removeAttr("disabled");var u={};f.serializeArray().forEach(function(t){var e=t.value.trim(),o=+e;u[t.name]=isNaN(o)?e:o}),function(s){if(!t.submitted&&t.form.id){var u=t.form;i.ajax({url:"https://docs.google.com/forms/d/"+u.id+"/formResponse?ifq",data:{[u.emailField]:s.email,[u.nameField]:s.name,[u.roleField]:s.role,[u.laField]:s.la},type:"POST",dataType:"xml"}),t.submitted=!0}var m=t.report,v=m.sections,b=[{key:"low",label:"Low support needs"},{key:"med",label:"Medium support needs"},{key:"high",label:"High support needs"}],g=0,w=0;["hotels","bnb","hostels"].forEach(function(t){g+=s["ta_new_"+t],w+=s["ta_new_"+t]*s["cost_"+t]});var _=g+s.ta_new_others,y=["bnb","hostels","nightly_paid_shared","prs_shared"].reduce(function(t,e){return t+s["ta_old_"+e]},0),E=s.ta_new_nprf/100,T=[{rows:[[s.la],[s.la2],[s.brma],[s.brma2]]},{rows:[[],[],[]]},{rows:[[I(s.asm_mgmt)],[I(s.asm_move_in_supp)],[I(s.asm_med_supp)],[I(s.asm_high_supp)],[P(s.asm_out_of_borough)]]},{rows:[],hasTotal:!0},{rows:[],hasTotal:!0}];T.forEach(function(t,e){t.title=v[0].tables[e],t.cols=v[0].headers[e];var o=v[0].rowLabels[e];o&&t.rows.forEach(function(t,e){t.unshift(o[e])})});var A={label:"Total",number:0,cost:0};b.forEach(function(t){var e=_*s["ta_new_"+t.key]/100*(1-E);T[3].rows.push({label:t.label,number:e}),T[4].rows.push([t.label,s["ta_old_"+t.key]/100*y])}),T[3].rows.push({label:"NRPF",number:_*E}),T[3].rows.forEach(function(t){t.cost=w/g*t.number*4,A.number+=t.number,A.cost+=t.cost}),T[4].rows.push(["Total",y]);var k={la:s.la,brma:s.brma,rent:s.la},x={la:s.la2,brma:s.brma2,rent:s.la2};d.forEach(function(t){var e,o;"Stock"===t.tab?(e="Area",o="la"):"LHAs"===t.tab?(e="BRMA",o="brma"):(e="Local Authority",o="rent"),t.data.forEach(function(t){[k,x].forEach(function(n){t[e]===n[o]&&(n[o]=t)})})}),T[1].cols[0].forEach(function(t,e){if(e>0){var o=parseInt(k.la["Available - "+t.replace("P","")+"%"]),n=A.number/o;T[1].rows[0].push(o),T[1].rows[1].push(P(100*n)),T[1].rows[2].push(n<.33?"Low":n>.66?"High":"Moderate")}});for(var C=[],L=0;L<2;L++){for(var R=v[L+1],H={title:R.title,tables:[]},M=0;M<2;M++){var S=R.firstHeaders,N={title:R.tables[M],cols:[[""],[""]],rows:[new Array(2*R.otherHeaders.length+(S?S.length-1:0)).fill(0)]};S&&N.cols.forEach(function(t,e){t.push(S[e])}),R.otherHeaders.forEach(function(t){N.cols[0].push({cols:2,label:t}),N.cols[1].push("Move to PRS as TA"),N.cols[1].push("Move to PRS as Permanent Accommodation")}),H.tables.push(N)}C.push(H)}function F(t,e,o){return(1-o)*t+o*e}function I(t){return"&pound;"+Math.round(t).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function P(t){return Math.round(100*t)/100+"%"}function $(t){return Math.round(10*t)/10}function j(t,e,o){var n=T[3].rows[e],a=T[4].rows[e],r=F(k.rent[.3],x.rent[.3],o)+s.asm_mgmt+s.asm_move_in_supp;1===e?r+=s.asm_med_supp:2===e&&(r+=s.asm_high_supp);var l=r-F(k.brma["90% 2011 LHA Rate"],x.brma["90% 2011 LHA Rate"],o),i=r-F(k.brma["2020 LHA Rate"],x.brma["2020 LHA Rate"],o),c=n.number*l*4,p=n.number*i*4;return{emergency:[n.cost,c,p,n.cost-c,n.cost-p,12*(n.cost-c),12*(n.cost-p)],temporary:[a[1]*l*4,a[1]*i*4,a[1]*l*4*12,a[1]*i*4*12]}}b.forEach(function(t,e){var o=j(t,e,0),n=j(t,e,s.asm_out_of_borough/100);[[C[0].tables[0],o.emergency],[C[0].tables[1],n.emergency],[C[1].tables[0],o.temporary],[C[1].tables[1],n.temporary]].forEach(function(e){var o=e[0],n=e[1];n.forEach(function(t,e){o.rows[o.rows.length-1][e]+=t}),o.rows.splice(-1,0,[t.label].concat(n.map(I)))})}),T[3].rows.push(A),T[3].rows=T[3].rows.map(function(t){return[t.label,$(t.number),I(t.cost)]}),T[4].rows.forEach(function(t){t[1]=$(t[1])}),C.forEach(function(t){t.full=!0,t.tables.forEach(function(t){t.hasTotal=!0,t.rows[t.rows.length-1]=t.rows[t.rows.length-1].map(I),t.rows[t.rows.length-1].unshift("Total")})}),C.unshift({tables:T,full:!1}),f.hide(),p.hide();var D=n("report").append("<h2>"+m.title+"</h2>").appendTo(c);D.append(C.map(function(t){var n=i('<section class="html2pdf__page-break t-s"></section>');t.title&&(n.addClass("ol"),n.append('<h4 class="s-t">'+t.title+"</h4>"));var a=null;return t.tables.forEach(function(r,s){s%(t.full?1:2)==0&&(a=o("ts").toggleClass("full",t.full).appendTo(n)),a.append(function(t,n){var a=e("table"),r=[],s=!1;if((t.cols?t.cols[0]:t.rows[0]).forEach(function(t){for(var e=t.cols||1,o=0;o<e;o++)r.push(s?"even":"odd");s=!s}),t.cols){var l=e("thead").appendTo(a);t.cols.length>1&&l.addClass("multirow"),t.cols.forEach(function(t){var o=e("tr").appendTo(l),n=0;t.forEach(function(t){var a=e("th").addClass(r[n]).appendTo(o);"object"==typeof t?(a.attr("colspan",t.cols).html(t.label),n+=t.cols):(a.html(t),n++)})})}var c=e("tbody").appendTo(a);t.rows.forEach(function(o,n){var a=e("tr").appendTo(c),s=0;o.forEach(function(t){var o=e("td").append(t).appendTo(a);r&&o.addClass(r[s++])}),t.hasTotal&&n===t.rows.length-1&&a.addClass("totals")});var p=o("t-title","<h4>"+t.title+"</h4>");if(n){var u=t.rows[t.rows.length-1];i('<h4 class="t-total"></h4>').html(u[u.length-1]).appendTo(p)}return o("t").append(p).append(a)}(r,t.full))}),n}));var O=o("f-bs").appendTo(D);i(a).text(l.change).on("click",function(){f.show(),p.show(),D.remove(),h(r.length-1)}).appendTo(O),i(a).html(l.download).on("click",function(){D.addClass("topdf");var t=n("cloth","Converting to pdf...").appendTo(i("body"));setTimeout(function(){html2pdf().from(D[0]).set({margin:.2,filename:"report-"+(new Date).toISOString().substr(0,16).replace(/[^0-9]/g,"")+".pdf",html2canvas:{scale:2,ignoreElements:function(t){return i(t).hasClass("f-bs")}},jsPDF:{unit:"in",format:"a4",orientation:"landscape"}}).save().finally(function(){D.removeClass("topdf"),t.remove()})},10)}).appendTo(O)}(u)}});var d={};function h(e){t.pageIndex=e;var o=r[e],n=f.find(".f-p").hide();n.find("input, select").attr("disabled","disabled"),n.filter("#"+o.id).show().find("input, select").removeAttr("disabled"),p.find(".cnctr-prog").css({width:100*e/(r.length-1)+"%"}),p.find(".p-n").each(function(t){i(this).toggleClass("active",t<=e)}),p.offset().top<i(window).scrollTop()&&p.get(0).scrollIntoView({behavior:"smooth"})}function m(){var e=f.get(0),o="reportValidity",n=!e[o]||e[o]();return r[t.pageIndex].groups.forEach(function(t){t.inputs.forEach(function(t){g(t),n&=!t.error});var e=w(t);n&=!e,t.inputs.forEach(function(t){v(t,t.error||e)})}),n}function v(t,e){var o=e?"slideDown":"slideUp";t.$dom.closest(".f-g").toggleClass("invalid",!!e).find(".err-msg")[o]().text(e)}function b(t,e){if(g(t),e.validation){var o=w(e);e.inputs.forEach(function(t){v(t,t.error||o)})}else v(t,t.error)}function g(t){var e=(t.$dom.val()||"").trim(),o=null;if(e||(o="req",t.$dom.attr("inputmode")&&(o+="Num")),!o)if("email"===t.type)/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(e)||(o="email");else if("text"===t.type);else if("select"!==t.type){isNaN(+e)||e<0?o="posNum":"percent"===t.type&&e>100&&(o="percent")}t.error=o?s[o]:null}function w(t){var e=null;if("percent"===t.validation){var o=0,n=0;t.inputs.forEach(function(t){t.error||(o+=parseInt(t.$dom.val().trim()),n++)}),n===t.inputs.length&&100!==o&&(e=s.percentTotal)}return e}["Stock","LHAs","Rents"].forEach(function(t){d[t]={tab:t,complete:!1,inputs:[]}}),r.forEach(function(t,n){o("p-n",n+1).appendTo(p),t.id="section-"+(n+1);var s=i('<section class="f-p" id="'+t.id+'"></section>').append('<h2 class="s-n">Section '+(n+1)+"</h2>").append('<h2 class="s-t">'+t.title+"</h2>");t.desc.forEach(function(t){s.append("<p>"+t+"</p>")}),t.groups.forEach(function(t,a){var r=e("fieldset");t.label&&r.append(e("legend",t.label)),t.inputs.forEach(function(s,l){var c,p="input_"+n+"-"+a+"-"+l;"select"===s.type?(c=i('<select id="'+p+'"></select>').append('<option selected disabled value="">'+s.placeholder+"</option>"),d[s.source[0]].inputs.push(s)):"text"===s.type||"email"===s.type?c=i('<input type="'+s.type+'" />'):(c=i('<input type="text" inputmode="numeric" pattern="[0-9]+"/>'),s.default&&c.attr("value",s.default));var u=o("w-input"+(s.type?" type-"+s.type:""),"pounds"===s.type?o("i-pre","&pound;"):null);c.attr("id",p).attr("name",s.name).attr("required","required").on("change",function(){b(s,t)}).on("blur",function(){b(s,t)}).appendTo(u),s.$dom=c,"percent"===s.type&&u.append(o("i-suf","%")),o("f-g").append(e("label",s.label).attr("for",p)).append(u).append(o("err-msg")).appendTo(r)}),r.appendTo(s)});var c=o("f-bs").appendTo(s);n>0?i(a).text(l.prev).on("click",function(){h(n-1)}).appendTo(c):o(null,"&nbsp;").appendTo(c),n===r.length-1?i(a).text(l.submit).attr("type","submit").on("click",function(){m()}).appendTo(c):n<r.length-1&&i(a).text(l.next).on("click",function(){m()&&h(n+1)}).appendTo(c),s.appendTo(f)}),(d=Object.values(d)).forEach(function(e){i.get("https://sheets.googleapis.com/v4/spreadsheets/"+t.sheetId+"/values/"+e.tab+"?valueRenderOption=UNFORMATTED_VALUE&key="+t.apiKey).then(function(t){var o=t.values.shift().map(function(t){return(""+t).trim()});e.data=t.values.map(function(t){var e={};return o.forEach(function(o,n){e[o]=t[n]}),e}),e.complete=!0,d.map(function(t){return t.complete}).filter(Boolean).length===d.length&&(d.forEach(function(t){t.inputs.forEach(function(e){t.data.forEach(function(t){var o=t[e.source[1]];e.$dom.append('<option value="'+o+'">'+o+"</option>")})})}),u.remove(),h(0))}).catch(function(t){console.log(t)})})}try{init(costingTool)}catch(t){console.error(t)}